version: '3.9'

services:

  # ── MongoDB ───────────────────────────────────────────────────────────────
  mongo:
    image: mongo:7
    container_name: mirage-mongo
    restart: unless-stopped
    ports:
      - '27017:27017'
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', 'db.adminCommand("ping")']
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Python Worker (FastAPI) ───────────────────────────────────────────────
  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: mirage-worker
    restart: unless-stopped
    ports:
      - '8000:8000'
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - UPLOADTHING_SECRET=${UPLOADTHING_SECRET}
      - UPLOADTHING_TOKEN=${UPLOADTHING_TOKEN}
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8000/health']
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

  # ── Node.js Backend (Express) ─────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mirage-backend
    restart: unless-stopped
    ports:
      - '5001:5000'
    environment:
      - PORT=5000
      - MONGO_URI=mongodb://mongo:27017/mirage
      - WORKER_URL=http://worker:8000
      - FRONTEND_URL=http://localhost:3000
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - HF_TOKEN=${HF_TOKEN}
      - UPLOADTHING_SECRET=${UPLOADTHING_SECRET}
      - UPLOADTHING_TOKEN=${UPLOADTHING_TOKEN}
    depends_on:
      mongo:
        condition: service_healthy
      worker:
        condition: service_healthy

  # ── React Frontend ────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=http://localhost:5001/api
        - REACT_APP_UPLOADTHING_URL=http://localhost:5001/api/uploadthing
    container_name: mirage-frontend
    restart: unless-stopped
    ports:
      - '3000:80'
    depends_on:
      - backend

volumes:
  mongo-data:
